<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="https://d3js.org/d3.v6.min.js"></script>
    <title>VI</title>
</head>
<style>
    .bar {
        fill: steelblue;
    }
    .bar-label {
        font-size: 10px;
        fill: black;
        text-anchor: middle;
    }
    .axis-label {
        font-size: 12px;
    }
    .graphGroup {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        column-gap: 40px;
        row-gap: 20px;
        place-items: center;
    }
    .graph {
        grid-column: span 2;
    }
    .graph:last-child {
        grid-column: auto / span 2;
    }
</style>
<body>
    <div class="graphGroup">
        <div class="graph">
            <h2>Taxa de Aprovados / Ano</h2>
            <div id="approvedPerYearChart" style="width: 400px; height: 300px;"></div>
        </div>
        <div class="graph">
            <h2>Regime</h2>
            <div id="regimeChart" style="width: 400px; height: 300px;"></div>
        </div>
        <div class="graph">
            <h2>Estudantes / Ano</h2>
            <div id="studentsPerYearChart" style="width: 400px; height: 300px;"></div>
        </div>
        <div class="graph">
            <h2>Estudantes / Departamento</h2>
            <div id="studentsPerDeptChart" style="width: 800px; height: 500px;"></div>
        </div>
    </div>

    <script type="text/javascript">
        // Load the CSV file and process the data
        d3.csv("notas-alunos-2012-2022-corrigido.csv").then(function(data) {
            // Check if data is loaded correctly
            console.log("Loaded Data:", data);
            let x,y;

            // Parse necessary columns into correct data types
            data.forEach(d => {
                d.ianolectivo = +d.ianolectivo;  // Convert year to integer
                d.aprovado = d.aprovado === "1" ? 1 : 0;  // Convert approved flag to integer
            });
            
        //
        // 1. Line Chart for Approval Percentage per Year
        //

            const approvalData = d3.group(data, d => d.ianolectivo);
            const approvalPercentage = Array.from(approvalData, ([year, records]) => {
                const total = records.length;
                const approved = records.filter(d => d.aprovado === 1).length;
                return { year, percentage: (approved / total) * 100 };
            });

            // Create SVG for Line Chart
            const svgLine = d3.select("#approvedPerYearChart").append("svg")
                            .attr("width", 400)
                            .attr("height", 300);

            // Define scales and axes for Line Chart
            x = d3.scaleLinear().domain(d3.extent(approvalPercentage, d => d.year)).range([20, 380]);
            y = d3.scaleLinear().domain([0, 100]).range([280, 20]);

            svgLine.append("g")
                .attr("transform", "translate(0,280)")
                .call(d3.axisBottom(x).ticks(5).tickFormat(d3.format("d")));

            svgLine.append("g")
                .attr("transform", "translate(20,0)")
                .call(d3.axisLeft(y));

            // Draw the line for approval percentage
            svgLine.append("path")
                .datum(approvalPercentage)
                .attr("fill", "none")
                .attr("stroke", "purple")
                .attr("stroke-width", 2)
                .attr("d", d3.line()
                    .x(d => x(d.year))
                    .y(d => y(d.percentage))
                );

        //
        // 2. Pie Chart for Regime Distribution
        //

        const regimeData = d3.rollups(data, v => v.length, d => d.nome_regime);
        console.log("Regime Data:", regimeData);

        const pie = d3.pie().value(d => d[1]);
        const arc = d3.arc().innerRadius(0).outerRadius(150);
        const color = d3.scaleOrdinal(d3.schemeCategory10);

        const svgPie = d3.select("#regimeChart").append("svg")
                        .attr("width", 400)
                        .attr("height", 300)
                        .append("g")
                        .attr("transform", "translate(250,150)");

        svgPie.selectAll("path")
            .data(pie(regimeData))
            .enter().append("path")
            .attr("d", arc)
            .attr("fill", d => color(d.data[0]));

        // Adding legend outside the pie chart
        const legend = svgPie.selectAll(".legend")
            .data(regimeData)
            .enter().append("g")
            .attr("class", "legend")
            .attr("transform", (d, i) => `translate(-550, ${i * 20 - 10})`); // Adjust position as needed

        legend.append("rect")
            .attr("x", 300)
            .attr("y", 10)
            .attr("width", 15)
            .attr("height", 15)
            .attr("fill", d => color(d[0]));

        legend.append("text")
            .attr("x", 320)
            .attr("y", 22)
            .attr("dy", "0.35em")
            .text(d => d[0]);

            
    // 
    // .3 Area Chart for students per year
    //

        const studentsPerYear = d3.rollups(data, v => v.length, d => d.ianolectivo);

        x = d3.scaleLinear().domain(d3.extent(studentsPerYear, d => d[0])).range([60, 380]);
        y = d3.scaleLinear().domain([0, d3.max(studentsPerYear, d => d[1])]).range([260, 40]);

        const area = d3.area()
                    .x(d => x(d[0]))
                    .y0(260)
                    .y1(d => y(d[1]));

        const svgArea = d3.select("#studentsPerYearChart").append("svg")
                    .attr("width", 400)
                    .attr("height", 300);

        svgArea.append("path")
        .datum(studentsPerYear)
        .attr("fill", "steelblue")
        .attr("opacity", 0.6)
        .attr("d", area);

            // Add x-axis
        svgArea.append("g")
            .attr("transform", "translate(0,260)")
            .call(d3.axisBottom(x).tickFormat(d3.format("d"))); // Format x-axis ticks as years

        // Add y-axis
        svgArea.append("g")
            .attr("transform", "translate(60,0)")
            .call(d3.axisLeft(y));

        // Add x-axis label
        svgArea.append("text")
            .attr("class", "axis-label")
            .attr("x", 200) // Centered horizontally
            .attr("y", 295) // Slightly below the x-axis
            .style("text-anchor", "middle")
            .text("Ano");

        // Add y-axis label
        svgArea.append("text")
            .attr("class", "axis-label")
            .attr("transform", "rotate(-90)")
            .attr("x", -150) // Centered vertically
            .attr("y", 10) // Slightly left of the y-axis
            .style("text-anchor", "middle")
            .text("NÃºmero de Alunos");
        
    //
    // .4 Heatmap for students per department
    //

    const deptData = d3.rollups(data, v => v.length, d => d.ianolectivo, d => d.dep_sigla_oficial.toUpperCase());

        const svgHeatmap = d3.select("#studentsPerDeptChart").append("svg")
                            .attr("width", 800)  // Adjust width as needed
                            .attr("height", 500); // Adjust height as needed

        const colorScale = d3.scaleSequential(d3.interpolateYlOrRd)
                            .domain([0, d3.max(deptData, d => d3.max(d[1], dd => dd[1]))]);

        // Flattened data for easier positioning
        const flattenedData = deptData.flatMap((yearData, yearIndex) =>
            yearData[1].map((deptData, deptIndex) => ({
                year: yearData[0],
                department: deptData[0],
                count: deptData[1],
                x: yearIndex,
                y: deptIndex
            }))
        );

        // Scales for positioning
        const xScale = d3.scaleBand()
                        .domain(deptData.map(d => d[0])) // Years
                        .range([100, 700])
                        .padding(0.05);

        const yScale = d3.scaleBand()
                        .domain(flattenedData.map(d => d.department)) // Departments
                        .range([50, 450])
                        .padding(0.05);

        // Draw cells in heatmap
        svgHeatmap.selectAll("rect")
            .data(flattenedData)
            .enter().append("rect")
            .attr("x", d => xScale(d.year))
            .attr("y", d => yScale(d.department))
            .attr("width", xScale.bandwidth())
            .attr("height", yScale.bandwidth())
            .attr("fill", d => colorScale(d.count));

        // Adding labels for years on the x-axis
        svgHeatmap.append("g")
            .attr("transform", `translate(0, ${450})`)
            .call(d3.axisBottom(xScale))
            .selectAll("text")
            .attr("transform", "rotate(-45)")
            .style("text-anchor", "end");

        // Adding labels for departments on the y-axis
        svgHeatmap.append("g")
            .attr("transform", `translate(100, 0)`)
            .call(d3.axisLeft(yScale));

        }).catch(function(error) {
            console.error("Error loading the CSV file:", error);
        });
    </script>
</body>
</html>
